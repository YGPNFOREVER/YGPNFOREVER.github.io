(()=>{function f(o,t,n){var e=document.createElement(o);for(let i in t)if(i&&t.hasOwnProperty(i)){let r=t[i];i=="dangerouslySetInnerHTML"?e.innerHTML=r.__html:r===!0?e.setAttribute(i,i):r!==!1&&r!=null&&e.setAttribute(i,r.toString())}for(let i=2;i<arguments.length;i++){let r=arguments[i];r&&e.appendChild(r.nodeType==null?document.createTextNode(r.toString()):r)}return e}var p=f;var T={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","\u2026":"&hellip;"};function w(o){return T[o]||o}function g(o){return o.replace(/[&<>"]/g,w)}function v(o){return o.replace(/[.*+\-?^${}()|[\]\\]/g,"\\$&")}var m=class o{data;form;input;list;resultTitle;resultTitleTemplate;constructor({form:t,input:n,list:e,resultTitle:i,resultTitleTemplate:r}){this.form=t,this.input=n,this.list=e,this.resultTitle=i,this.resultTitleTemplate=r,this.input.value.trim()!==""?this.doSearch(this.input.value.split(" ")):this.handleQueryString(),this.bindQueryStringChange(),this.bindSearchForm()}static processMatches(t,n,e=!0,i=140,r=20){n.sort((a,l)=>a.start-l.start);let u=0,s=0,c=0,h=[];for(;u<n.length;){let a=n[u];e&&a.start-r>s?(h.push(`${g(t.substring(s,s+r))} [...] `),h.push(`${g(t.substring(a.start-r,a.start))}`),c+=r*2):(h.push(g(t.substring(s,a.start))),c+=a.start-s);let l=u+1,d=a.end;for(;l<n.length&&n[l].start<=d;)d=Math.max(n[l].end,d),++l;if(h.push(`<mark>${g(t.substring(a.start,d))}</mark>`),c+=d-a.start,u=l,s=d,e&&c>i)break}if(s<t.length){let a=t.length;e&&(a=Math.min(a,s+r)),h.push(`${g(t.substring(s,a))}`),e&&a!=t.length&&h.push(" [...]")}return h.join("")}async searchKeywords(t){let n=await this.getData(),e=[],i=new RegExp(t.filter((r,u,s)=>(s[u]=v(r),r.trim()!=="")).join("|"),"gi");for(let r of n){let u=[],s=[],c={...r,preview:"",matchCount:0},h=r.content.matchAll(i);for(let l of Array.from(h))s.push({start:l.index,end:l.index+l[0].length});let a=r.title.matchAll(i);for(let l of Array.from(a))u.push({start:l.index,end:l.index+l[0].length});u.length>0&&(c.title=o.processMatches(c.title,u,!1)),s.length>0?c.preview=o.processMatches(c.content,s):c.preview=g(c.content.substring(0,140)),c.matchCount=u.length+s.length,c.matchCount>0&&e.push(c)}return e.sort((r,u)=>u.matchCount-r.matchCount)}async doSearch(t){let n=performance.now(),e=await this.searchKeywords(t);this.clear();for(let r of e)this.list.append(o.render(r));let i=performance.now();this.resultTitle.innerText=this.generateResultTitle(e.length,((i-n)/1e3).toPrecision(1))}generateResultTitle(t,n){return this.resultTitleTemplate.replace("#PAGES_COUNT",t).replace("#TIME_SECONDS",n)}async getData(){if(!this.data){let t=this.form.dataset.json;this.data=await fetch(t).then(e=>e.json());let n=new DOMParser;for(let e of this.data)e.content=n.parseFromString(e.content,"text/html").body.innerText}return this.data}bindSearchForm(){let t="",n=e=>{e.preventDefault();let i=this.input.value.trim();if(o.updateQueryString(i,!0),i==="")return t="",this.clear();t!==i&&(t=i,this.doSearch(i.split(" ")))};this.input.addEventListener("input",n),this.input.addEventListener("compositionend",n)}clear(){this.list.innerHTML="",this.resultTitle.innerText=""}bindQueryStringChange(){window.addEventListener("popstate",t=>{this.handleQueryString()})}handleQueryString(){let n=new URL(window.location.toString()).searchParams.get("keyword");this.input.value=n,n?this.doSearch(n.split(" ")):this.clear()}static updateQueryString(t,n=!1){let e=new URL(window.location.toString());t===""?e.searchParams.delete("keyword"):e.searchParams.set("keyword",t),n?window.history.replaceState("","",e.toString()):window.history.pushState("","",e.toString())}static render(t){return p("article",null,p("a",{href:t.permalink},p("div",{class:"article-details"},p("h2",{class:"article-title",dangerouslySetInnerHTML:{__html:t.title}}),p("section",{class:"article-preview",dangerouslySetInnerHTML:{__html:t.preview}})),t.image&&p("div",{class:"article-image"},p("img",{src:t.image,loading:"lazy"}))))}};function M(){if(document.querySelector(".search-result")){let t=document.querySelector(".search-form"),n=t.querySelector("input"),e=document.querySelector(".search-result--list"),i=document.querySelector(".search-result--title");new m({form:t,input:n,list:e,resultTitle:i,resultTitleTemplate:window.searchResultTitleTemplate})}}var L=m;})();
